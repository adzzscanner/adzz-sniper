<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phase 1 - Flash (Spot) + Grid Scanner</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin:0; padding:16px; line-height:1.5; background:#fff; color:#000; }
  .container { max-width: 900px; margin: 0 auto; }
  h1 { text-align:center; font-size:32px; margin-bottom:16px; }
  #scanBtn { display:block; margin:0 auto 20px auto; padding:14px 24px; font-size:22px; font-weight:700; background:#2563eb; color:#fff; border:none; border-radius:12px; cursor:pointer; }
  .coin-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:600px){ .coin-grid { grid-template-columns:1fr; } }
  .coin-card { border:2px solid #000; border-radius:12px; padding:16px; text-align:center; font-size:18px; }
  .coin-name { font-weight:700; font-size:20px; margin-bottom:12px; }
  .status-button { display:inline-block; padding:8px 16px; margin:8px 0; font-size:18px; font-weight:700; border-radius:8px; }
  .status-grid { background:#10b981; color:#fff; }
  .status-flash { background:#f59e0b; color:#000; }
  .status-wait { background:#3b82f6; color:#fff; }
  .trend-tag { margin:6px 0; font-size:14px; font-weight:600; }
  .trend-bull { color:#ef4444; }
  .trend-bear { color:#6b7280; }
  .trend-range { color:#10b981; }
  .momentum-tag { margin:4px 0; font-size:13px; font-weight:600; padding:3px 6px; border-radius:4px; }
  .momentum-up { background:#dcfce7; color:#166534; }
  .momentum-down { background:#fee2e2; color:#991b1b; }
  .momentum-neutral { background:#f3f4f6; color:#4b5563; }
  .footer { text-align:center; margin-top:24px; font-size:16px; color:#555; }
</style>
</head>
<body>
<div class="container">
  <h1>âš¡ Phase 1 - Flash (Spot) + Grid Scanner</h1>
  <button id="scanBtn">ðŸ”„ Scan All Coins</button>

  <div class="coin-grid" id="coinGrid">
    <!-- Results appear here -->
  </div>

  <div class="footer">
    ðŸ”’ Phase 1: $0 â†’ $1,000 â€¢ Flash = Spot Only | Grid: PEPE/DOGE/LTC
  </div>
</div>

<script>
const coins = ["1000PEPEUSDT","DOGEUSDT","ATOMUSDT","NEARUSDT","ZENUSDT","TIAUSDT","LTCUSDT"];
const coinGrid = document.getElementById("coinGrid");
const scanBtn = document.getElementById("scanBtn");

// Proxy URL to fetch real-time data
const PROXY_URL = "https://bybit-proxy.adzzscanner.workers.dev";

function calculateRSI(closes, period = 6){
  let gains = 0, losses = 0;
  for(let i = 1; i < closes.length; i++){
    let diff = closes[i] - closes[i-1];
    if(diff > 0) gains += diff;
    else losses += Math.abs(diff);
  }
  let avgGain = gains / period;
  let avgLoss = losses / period;
  if(avgLoss === 0) return 100;
  let rs = avgGain / avgLoss;
  return 100 - (100 / (1 + rs));
}

function isRanging(closes){
  const recent = closes.slice(-6);
  const high = Math.max(...recent);
  const low = Math.min(...recent);
  return ((high - low) / low * 100) <= 1.0;
}

function getStructuralTrend(closes){
  const recent = closes.slice(-6);
  const start = recent[0];
  const end = recent[recent.length - 1];
  const netChange = ((end - start) / start) * 100;
  
  if (netChange < -3.0) return "â†“ Strong Downtrend";
  if (netChange < -1.0) return "â†˜ Weak Downtrend";
  if (netChange > 3.0) return "â†‘ Strong Uptrend";
  if (netChange > 1.0) return "â†— Short Bull";
  return "â†” Ranging";
}

function getMomentumTag(closes){
  if (closes.length < 6) return "âšª Neutral";
  const recent2 = closes.slice(-2);
  const prior4 = closes.slice(-6, -2);
  const avgRecent = (recent2[0] + recent2[1]) / 2;
  const avgPrior = (prior4[0] + prior4[1] + prior4[2] + prior4[3]) / 4;
  const change = ((avgRecent - avgPrior) / avgPrior) * 100;
  
  if (change > 0.8) return "ðŸŸ¢ Bull Momentum";
  if (change < -0.8) return "ðŸ”´ Bear Momentum";
  return "âšª Neutral";
}

async function getRangeFrom1h(symbol){
  try{
    const url = `${PROXY_URL}/kline?category=linear&symbol=${symbol}&interval=60&limit=24`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.result?.list || data.result.list.length < 2) return null;

    const klines = data.result.list.map(k => ({
      low: parseFloat(k[3]),
      high: parseFloat(k[2])
    })).reverse();

    const rangeLow = Math.min(...klines.map(k => k.low));
    const rangeHigh = Math.max(...klines.map(k => k.high));
    return { rangeLow, rangeHigh };
  }catch(e){
    console.error("Range error:", symbol, e);
    return null;
  }
}

async function get15mData(symbol){
  try{
    const url = `${PROXY_URL}/kline?category=linear&symbol=${symbol}&interval=15&limit=20`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.result?.list || data.result.list.length < 2) return null;

    const klines = data.result.list.map(k => ({
      high: parseFloat(k[2]),
      low: parseFloat(k[3]),
      close: parseFloat(k[4]),
      volume: parseFloat(k[5])
    })).reverse();

    const closes = klines.map(k => k.close);
    const volumes = klines.map(k => k.volume);
    const latestClose = closes[closes.length - 1];
    const prevHigh = Math.max(...closes.slice(0, -1));
    const dipPercent = ((prevHigh - latestClose) / prevHigh) * 100;
    const totalVolume = volumes.reduce((a,b) => a + b, 0);
    const rsi = calculateRSI(closes, 6); // Use RSI(6) for Flash

    // Validate data
    if (isNaN(dipPercent) || !isFinite(dipPercent)) {
      return null;
    }

    return {
      closes,
      volumes,
      latestClose,
      prevHigh,
      dipPercent,
      totalVolume,
      rsi
    };
  }catch(e){
    console.error("15m data error:", symbol, e);
    return null;
  }
}

async function get24hData(symbol){
  try{
    const url = `${PROXY_URL}/tickers?category=linear&symbol=${symbol}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.result?.list || data.result.list.length < 1) return null;

    const ticker = data.result.list[0];
    const high24 = parseFloat(ticker.highPrice);
    const low24 = parseFloat(ticker.lowPrice);
    const vol24 = parseFloat(ticker.turnover);

    // Validate data
    if (isNaN(high24) || isNaN(low24) || isNaN(vol24)) {
      return null;
    }

    return {
      high24,
      low24,
      vol24
    };
  }catch(e){
    console.error("24h data error:", symbol, e);
    return null;
  }
}

function getWaitReason(structuralTrend, momentumTag, rsi, dipPercent){
  const isStrongUp = structuralTrend.includes("Strong Uptrend");
  const isStrongDown = structuralTrend.includes("Strong Downtrend");
  const hasBearMomentum = momentumTag.includes("Bear Momentum");
  const hasBullMomentum = momentumTag.includes("Bull Momentum");

  if (isStrongUp && hasBearMomentum) {
    return "Let it cool down â€“ wait for entry";
  }
  if (isStrongDown && hasBullMomentum) {
    return "Let it cool down â€“ wait for confirmation";
  }
  if (rsi > 30 && dipPercent < 8) {
    return "No dip yet â€“ wait for pullback";
  }
  if (rsi > 60) {
    return "Overextended â€“ avoid longs";
  }
  return "No valid setup";
}

async function scanCoin(symbol){
  try{
    const rangeData = await getRangeFrom1h(symbol);
    if(!rangeData) return null;

    const data15m = await get15mData(symbol);
    if(!data15m) return null;

    const data24h = await get24hData(symbol);
    if(!data24h) return null;

    const {
      closes,
      volumes,
      latestClose,
      prevHigh,
      dipPercent,
      totalVolume,
      rsi
    } = data15m;

    const { high24, low24, vol24 } = data24h;

    // Recalculate dip using 24h high
    const dipPercent24h = ((high24 - latestClose) / high24) * 100;

    // Validate dip
    if (isNaN(dipPercent24h) || !isFinite(dipPercent24h)) {
      return null;
    }

    const { rangeLow, rangeHigh } = rangeData;

    const canGrid = ["1000PEPEUSDT", "DOGEUSDT", "LTCUSDT"].includes(symbol);
    const gridPass = canGrid && totalVolume >= 10_000_000 && isRanging(closes);
    const flashPass = rsi <= 30 && totalVolume >= 15_000_000 && dipPercent24h >= 8;

    let status = "WAIT";
    let statusClass = "status-wait";
    let actionLabel = "WAIT";
    let actionClass = "status-wait";

    if (gridPass && flashPass) {
      if (rsi <= 25 && totalVolume >= 20_000_000 && dipPercent24h >= 10) {
        status = "Grid + Flash (Strong)";
        statusClass = "status-grid";
        actionLabel = "Grid + Flash";
        actionClass = "status-grid";
      } else {
        status = "Grid + Flash (Weak)";
        statusClass = "status-grid";
        actionLabel = "Grid + Flash";
        actionClass = "status-grid";
      }
    } else if (gridPass) {
      if (totalVolume >= 20_000_000) {
        status = "Grid x3 (Strong)";
        statusClass = "status-grid";
        actionLabel = "Grid x3";
        actionClass = "status-grid";
      } else {
        status = "Grid x3 (Weak)";
        statusClass = "status-grid";
        actionLabel = "Grid x3";
        actionClass = "status-grid";
      }
    } else if (flashPass) {
      if (rsi <= 25 && totalVolume >= 20_000_000 && dipPercent24h >= 10) {
        status = "Flash (Spot) Strong";
        statusClass = "status-flash";
        actionLabel = "Flash (Spot)";
        actionClass = "status-flash";
      } else {
        status = "Flash (Spot) Weak";
        statusClass = "status-flash";
        actionLabel = "Flash (Spot)";
        actionClass = "status-flash";
      }
    }

    const structuralTrend = getStructuralTrend(closes);
    const momentumTag = getMomentumTag(closes);
    const waitReason = getWaitReason(structuralTrend, momentumTag, rsi, dipPercent24h);

    return {
      symbol,
      price: latestClose,
      rangeLow,
      rangeHigh,
      rsi: rsi.toFixed(1),
      volume: totalVolume,
      dip: dipPercent24h.toFixed(1),
      status,
      statusClass,
      structuralTrend,
      momentumTag,
      actionLabel,
      actionClass,
      waitReason
    };
  }catch(e){
    console.error("Scan error:", symbol, e);
    return null;
  }
}

async function scanAll(){
  scanBtn.disabled = true;
  coinGrid.innerHTML = "<p>Scanning coins...</p>";
  const results = await Promise.all(coins.map(scanCoin));
  coinGrid.innerHTML = "";
  const valid = results.filter(r => r);

  if(valid.length === 0){
    coinGrid.innerHTML = "<p>No coins meet criteria right now.</p>";
    scanBtn.disabled = false;
    return;
  }

  valid.forEach(c => {
    const card = document.createElement("div");
    card.className = "coin-card";
    const volDisplay = (c.volume / 1e6).toFixed(1) + "M";
    const priceDisplay = c.symbol.includes("1000PEPE") 
      ? c.price.toFixed(7) 
      : c.symbol.includes("DOGE") 
        ? c.price.toFixed(4) 
        : c.price.toFixed(3);

    let trendColor = "";
    if (c.structuralTrend.includes("Strong Downtrend")) trendColor = "trend-bear";
    else if (c.structuralTrend.includes("Weak Downtrend")) trendColor = "trend-bear";
    else if (c.structuralTrend.includes("Strong Uptrend")) trendColor = "trend-bull";
    else if (c.structuralTrend.includes("Short Bull")) trendColor = "trend-bull";
    else trendColor = "trend-range";

    let momentumClass = "momentum-neutral";
    if (c.momentumTag.includes("Bull")) momentumClass = "momentum-up";
    else if (c.momentumTag.includes("Bear")) momentumClass = "momentum-down";

    card.innerHTML = `
      <div class="coin-name">${c.symbol}</div>
      <p>Price: ${priceDisplay}</p>
      <p>Range: ${c.rangeLow.toFixed(3)} â€“ ${c.rangeHigh.toFixed(3)}</p>
      <p>RSI: ${c.rsi} | Vol: ${volDisplay} | Dip: ${c.dip}%</p>
      <div class="trend-tag ${trendColor}">${c.structuralTrend}</div>
      <div class="momentum-tag ${momentumClass}">${c.momentumTag}</div>
      <div class="status-button ${c.actionClass}">${c.actionLabel}</div>
    `;
    coinGrid.appendChild(card);
  });

  scanBtn.disabled = false;
}

scanBtn.addEventListener("click", scanAll);
</script>
</body>
</html>
