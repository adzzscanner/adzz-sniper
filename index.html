<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Dip & Momentum Scanner v9.1</title>
  <style>
    body { font-family: monospace; background: #0f0f15; color: #eee; padding: 20px; }
    .signal { margin: 12px 0; padding: 10px; border-radius: 6px; }
    .flash { background: #2a1a3a; border-left: 4px solid #ff6b6b; }
    .normal { background: #1a2a2a; border-left: 4px solid #4ecdc4; }
    .momentum { background: #3a1a5a; border-left: 4px solid #a678ff; }
    .chaos { background: #1a0f1a; border-left: 4px solid #ffcc00; }
    .header { color: #ffcc00; margin: 20px 0 10px; }
    #modeBtn { margin-left: 10px; background: #222; color: #ffcc00; border: 1px solid #444; padding: 6px 10px; cursor: pointer; }
    .tp10 { border-top: 2px solid #4ecdc4; }
    .tp15 { border-top: 2px solid #ffcc00; box-shadow: 0 0 10px #ffcc00; }
  </style>
</head>
<body>
  <h2>üöÄ Crypto Dip & Momentum Scanner v9.1</h2>
  <p>Vol ‚â• $5M | DIP: 8‚Äì30% ‚Üí 10‚Äì15% TP | Momentum: 4‚Äì6% ‚Üí 10% TP | Chaos: 20‚Äì30% dip</p>
  <button onclick="runScan()">‚ñ∂Ô∏è Run Scan</button>
  <button onclick="toggleMode()" id="modeBtn">üìâ Mode: DIP</button>
  <div id="btcGateStatus" style="margin-top:10px;"></div>
  <div id="output" style="margin-top: 20px;"></div>

  <script>
    const FLASH_COINS = [
      "APTUSDT","SKYUSDT","TAOUSDT","JUPUSDT","ACTUSDT","CYBERUSDT","LUNAUSDT",
      "SQDUSDT","MAGMAUSDT","PENDLEUSDT","MEMEUSDT","HYPEUSDT","TURBOUSDT"
    ];

    const NORMAL_COINS = [
      "INJUSDT","SOLUSDT","FETUSDT","ZENUSDT","AAVEUSDT","AVAXUSDT","ZROUSDT",
      "ICPUSDT","LINKUSDT","PYTHUSDT","RENDERUSDT","SUIUSDT","DOTUSDT","ATOMUSDT",
      "NEARUSDT","OPUSDT","ARBUSDT","RNDRUSDT","IMXUSDT","SEIUSDT","WLDUSDT",
      "ORDIUSDT","PEPEUSDT","BONKUSDT","SHIBUSDT","DOGEUSDT","FLOKIUSDT",
      "GALAUSDT","HOLOUSDT","PUMPUSDT","JTOUSDT","EIGENUSDT","NEIROUSDT",
      "BOMEUSDT","WIFUSDT"
    ];

    const ALL_COINS = [...new Set([...FLASH_COINS, ...NORMAL_COINS])];
    const MIN_VOLUME_USD = 5_000_000;
    let CURRENT_MODE = "DIP";
    const MAX_RETRIES = 2;

    // BTC Gate Config (now 1-hour based)
    const BTC_GATE = {
      symbol: "BTCUSDT",
      maxDrop: -1.2,
      maxPump: 1.5,
      maxVolMultiplier: 2
    };
    let btcGatePass = true;

    function toggleMode() {
      CURRENT_MODE = (CURRENT_MODE === "DIP") ? "MOMENTUM" : "DIP";
      document.getElementById("modeBtn").innerText = (CURRENT_MODE === "DIP") ? "üìâ Mode: DIP" : "‚ö° Mode: MOMENTUM";
    }

    async function fetchTicker(symbol, retries = 0) {
      try {
        // FIXED: removed space after ?symbol=
        const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();
        const price = parseFloat(d.lastPrice);
        const change24h = parseFloat(d.priceChangePercent);
        const volumeUsd = parseFloat(d.quoteVolume);
        const low24h = parseFloat(d.lowPrice);
        if ([price, change24h, volumeUsd, low24h].some(v => !isFinite(v) || v <= 0)) throw new Error("Invalid data");
        return { price, change24h, volumeUsd, low24h };
      } catch (e) {
        if (retries < MAX_RETRIES) return fetchTicker(symbol, retries + 1);
        console.warn(`Failed to fetch ${symbol}:`, e);
        return null;
      }
    }

    // NEW: Fetch 1-hour BTC candle for accurate gate
    async function fetchBTC1hData() {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${BTC_GATE.symbol}&interval=1h&limit=2`);
        if (!res.ok) throw new Error(`Klines HTTP ${res.status}`);
        const data = await res.json();
        if (data.length < 2) throw new Error("Insufficient klines");

        const prevClose = parseFloat(data[0][4]); // close of previous 1h candle
        const currClose = parseFloat(data[1][4]); // close of latest 1h candle
        const change1h = ((currClose - prevClose) / prevClose) * 100;

        // Estimate 1h volume (use latest candle's quote volume)
        const volume1h = parseFloat(data[1][7]); // quote asset volume
        const avg24hVol = volume1h * 24; // rough 24h average
        const volMultiplier = volume1h / (avg24hVol / 24); // = volume1h / avg1hVol ‚Üí simplifies to 1, so we use 24h total instead

        // Better: get 24h volume from ticker for context
        const ticker = await fetchTicker(BTC_GATE.symbol);
        const vol24h = ticker ? ticker.volumeUsd : volume1h * 24;
        const avg1hVol = vol24h / 24;
        const volRatio = volume1h / avg1hVol;

        return { change1h, volume1h, vol24h, volRatio };
      } catch (e) {
        console.error("BTC 1h fetch error", e);
        return null;
      }
    }

    async function fetchBTCGate() {
      const data = await fetchBTC1hData();
      if (!data) {
        btcGatePass = true; // fail-safe
        document.getElementById("btcGateStatus").innerHTML = `<div style="color:#f90;">‚ö†Ô∏è BTC Gate: Using fallback (assumed PASS)</div>`;
        return;
      }

      const { change1h, volRatio } = data;
      const blocked = change1h < BTC_GATE.maxDrop || change1h > BTC_GATE.maxPump || volRatio > BTC_GATE.maxVolMultiplier;
      btcGatePass = !blocked;

      document.getElementById("btcGateStatus").innerHTML = btcGatePass
        ? `<div style="color:#0f0;">‚úÖ BTC Gate Passed (${change1h.toFixed(2)}% | Vol: ${volRatio.toFixed(1)}x)</div>`
        : `<div style="color:#f00;">‚ùå BTC Gate Blocked (${change1h.toFixed(2)}% | Vol: ${volRatio.toFixed(1)}x)</div>`;
    }

    function classifySignal(symbol, { price, change24h, volumeUsd, low24h }) {
      if (!price || !change24h || !volumeUsd || volumeUsd < MIN_VOLUME_USD) return null;
      let mode="", emoji="", css="", entryLow="", TP="", holdingTime="";
      const volScore = Math.min(150, Math.floor(volumeUsd / 5_000_000));

      if (CURRENT_MODE === "DIP") {
        if (change24h >= 0) return null;
        const dip = Math.abs(change24h);
        if (dip >= 8 && dip < 12) { mode="DIP"; emoji="üîπ"; css="normal"; TP="10%"; }
        else if (dip >= 12 && dip < 20) { mode="FLASH-DIP"; emoji="üöÄ"; css="flash"; TP="10‚Äì15%"; }
        else if (dip >= 20 && dip <= 30) { mode="CHAOS-DIP"; emoji="üí•"; css="chaos"; TP="10‚Äì15%"; }
        else return null;
        entryLow = (price * (1 - dip/100*0.5)).toFixed(6);
        holdingTime="12‚Äì36h rebound";
      }

      if (CURRENT_MODE === "MOMENTUM") {
        if (change24h < 4 || change24h > 6) return null;
        mode="MOMENTUM"; emoji="‚ö°"; css="momentum";
        entryLow = (low24h*1.01).toFixed(6);
        TP="10%";
        holdingTime="2‚Äì12h continuation";
      }

      const tpClass = TP.includes('15') ? 'tp15' : 'tp10';
      return `
        <div class="signal ${css} ${tpClass}">
          ${emoji} ${mode} | ${symbol.replace("USDT","")}
          <br>Price: $${price.toFixed(6)} | 24h: ${change24h.toFixed(2)}% | Vol: $${(volumeUsd/1e6).toFixed(1)}M | VolScore: ${volScore}
          <br>Entry: $${entryLow} ‚Äì $${price.toFixed(6)} | <b>TP: ${TP}</b> | Hold: ${holdingTime}
        </div>
      `;
    }

    async function runScan() {
      const outEl = document.getElementById("output");
      outEl.innerHTML = `<div class="header">Checking BTC Gate (1h)...</div>`;
      await fetchBTCGate();

      if (!btcGatePass) {
        outEl.innerHTML += `<div class="header">‚ùå Scan blocked by BTC Gate</div><div>BTC 1h move or volume too extreme</div>`;
        return;
      }

      outEl.innerHTML = `<div class="header">‚úÖ BTC Gate Passed ‚Üí Scanning ${ALL_COINS.length} coins in ${CURRENT_MODE} mode...</div>`;
      const results = [];

      for (const symbol of ALL_COINS) {
        const data = await fetchTicker(symbol);
        if (data) {
          const signal = classifySignal(symbol, data);
          if (signal) results.push(signal);
        }
      }

      if (!results.length) {
        outEl.innerHTML += `<div class="header">‚úÖ 0 Signals</div><div>No valid signals.</div>`;
      } else {
        outEl.innerHTML += `<div class="header">‚úÖ ${results.length} Signals Found (${CURRENT_MODE})</div>` + results.join("");
      }
    }
  </script>
</body>
</html>
