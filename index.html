<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bybit Live Scanner v3.5.4 (Strategy-Locked RSI)</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f0f; color: #f0f0f0; padding: 20px; line-height: 1.6; margin: 0; }
h1,h2,h3 { color: #4ade80; margin-top:1.5em; }
h1 { text-align:center; font-size:28px; margin-bottom:20px; margin-top:10px; }
h2 { font-size:22px; border-left:4px solid #4ade80; padding-left:12px; }
h3 { font-size:20px; color:#60a5fa; }
.coin-list,.rule,.alert-example,.debug-info { border-radius:10px; padding:12px; margin:12px 0; }
.coin-list { background:#1a1a1a; font-size:18px; word-break:break-word; }
.rule { background:#1e1b4b; font-size:18px; }
.alert-example { background:#1a1a1a; font-family:'Courier New', monospace; font-size:16px; color:#fbbf24; white-space:pre-wrap; line-height:1.4; }
.debug-info { background:#1a1a1a; border:1px solid #333; font-size:14px; color:#94a3b8; max-height:300px; overflow-y:auto; }
.total { font-size:20px; font-weight:bold; color:#f8fafc; background:#7c2d12; padding:12px; text-align:center; margin:20px 0; border-radius:8px; }
button { padding:12px 20px; font-size:18px; border-radius:8px; border:none; background:#4ade80; color:#0f0f0f; cursor:pointer; margin-top:8px; font-weight:bold; transition:all 0.3s; }
button:hover { background:#22c55e; transform:translateY(-2px); box-shadow:0 4px 12px rgba(74,222,128,0.3); }
button:disabled { background:#64748b; cursor:not-allowed; transform:none; }
.footer { text-align:center; margin-top:30px; color:#64748b; font-size:16px; }
#status { color:#60a5fa; margin:10px 0; font-weight:bold; }
.signal { margin:8px 0; padding:8px; border-radius:6px; }
.signal.flash { background:rgba(74,222,128,0.15); border-left:4px solid #4ade80; }
.signal.grid { background:rgba(251,191,36,0.15); border-left:4px solid #fbbf24; }
.signal.chaos { background:rgba(239,68,68,0.15); border-left:4px solid #ef4444; }
.coin-table { width:100%; border-collapse:collapse; margin:20px 0; font-size:14px; }
.coin-table th { background:#1e293b; padding:10px; text-align:left; border-bottom:2px solid #334155; }
.coin-table td { padding:10px; border-bottom:1px solid #334155; }
.coin-table tr:hover { background:rgba(255,255,255,0.05); }
.controls { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.control-group { background:#1a1a1a; padding:15px; border-radius:8px; flex:1; min-width:200px; }
.control-group label { display:block; margin-bottom:8px; color:#94a3b8; }
.control-group select, .control-group input { width:100%; padding:8px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:white; }
.progress-bar { width:100%; height:4px; background:#334155; border-radius:2px; margin:10px 0; overflow:hidden; }
.progress-fill { height:100%; background:#4ade80; width:0%; transition: width 0.3s; }
</style>
</head>
<body>

<h1>üî• Bybit Live Scanner v3.5.4 (Strategy-Locked RSI)</h1>
<div class="total">‚úÖ 39 Coins | Flash x5 | Grid x3 | Full 4-Day Validation</div>

<div class="controls">
  <div class="control-group">
    <label for="scanMode">Scan Mode:</label>
    <select id="scanMode">
      <option value="full" data-vol="1.5">Full Scan (All Signals)</option>
      <option value="flash" data-vol="2.0">Flash Signals Only</option>      <option value="grid" data-vol="1.0">Grid Signals Only</option>
      <option value="chaos" data-vol="3.0">Chaos Signals Only</option>
    </select>
  </div>
  <div class="control-group">
    <label for="rsiPeriod">RSI Period (Display Only):</label>
    <select id="rsiPeriod">
      <option value="6">6 (Default)</option>
      <option value="7">7</option>
      <option value="14">14</option>
    </select>
  </div>
  <div class="control-group">
    <label for="minVolumeRatio">Min Volume Ratio:</label>
    <input type="number" id="minVolumeRatio" value="1.5" step="0.1" min="1.0" max="10.0">
  </div>
</div>

<button onclick="scanLive()" id="scanBtn">üåê Scan Live Coin Universe</button>
<div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
<div id="status">Ready to scan. Click button to start.</div>

<div id="result" class="alert-example"></div>
<div class="debug-info" id="debugInfo"></div>
<h3>üìä Live Coin Data</h3>
<div id="coinTableContainer"></div>

<script>
// --- CONFIG ---
const CONFIG = { 
  gridRangeMin:15, 
  gridRangeMax:30, 
  gridMinTouches:3, 
  flashRsiLow:22, 
  flashRsiMed:27, 
  chaosDropMin:35, 
  emaSlopeMax:0.005 
};
const COIN_UNIVERSE = [
  "LITUSDT","WIFUSDT","PEPEUSDT","FOGOUSDT","PUMPFUNUSDT","LINEAUSDT","CAKEUSDT","POLUSDT",
  "SUIUSDT","ZENUSDT","SAROSUSDT","GAIBUSDT","APEXUSDT","LINKUSDT","DOGEUSDT","BONKUSDT",
  "SOLUSDT","INJUSDT","NEONUSDT","MNTUSDT","ONDOUSDT","ALCHUSDT","L3USDT","SWEATUSDT",
  "AAVEUSDT","NEARUSDT","TRUMPUSDT","FARTCOINUSDT","BREVUSDT","STBLUSDT","CUDISUSDT",
  "KMNOUSDT","YGGUSDT","AVAAIUSDT","YBUSDT","ZAMAUSDT","VIRTUALUSDT","ILVUSDT","QNTUSDT"
];

let debugLog = [];
function logDebug(msg) {
  const ts = new Date().toLocaleTimeString();
  debugLog.push(`[${ts}] ${msg}`);  const el = document.getElementById('debugInfo');
  if (el) {
    el.innerHTML = debugLog.slice(-20).join('<br>');
    el.scrollTop = el.scrollHeight;
  }
}

const scanModeSelect = document.getElementById('scanMode');
const rsiPeriodSelect = document.getElementById('rsiPeriod');
const minVolumeInput = document.getElementById('minVolumeRatio');

scanModeSelect.addEventListener('change', () => {
  const opt = scanModeSelect.selectedOptions[0];
  minVolumeInput.value = opt.dataset.vol;
});

// --- Core Indicators ---
function calculateRSI(prices, period) {
  if (prices.length < period + 1) return 50;
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = prices[prices.length - i] - prices[prices.length - i - 1];
    if (diff > 0) gains += diff;
    else losses -= diff;
  }
  if (losses === 0) return 100;
  const avgGain = gains / period;
  const avgLoss = losses / period;
  const rs = avgGain / avgLoss;
  return 100 - (100 / (1 + rs));
}

function calculateEMA(prices, period) {
  if (prices.length < period) return prices.length ? prices[prices.length - 1] : null;
  let sum = 0;
  for (let i = 0; i < period; i++) sum += prices[i];
  let ema = sum / period;
  const k = 2 / (period + 1);
  for (let i = period; i < prices.length; i++) {
    ema = (prices[i] * k) + (ema * (1 - k));
  }
  return ema;
}

function calculateVolumeRatio(vols, lookback = 20) {
  if (vols.length < lookback + 1) return 1;
  const current = vols[vols.length - 1];
  const prev = vols.slice(-lookback - 1, -1);
  const avg = prev.reduce((a, b) => a + b, 0) / lookback;
  return current / avg;}

function validateGrid(klines) {
  if (klines.length < 96 * 4) return null;
  const last4d = klines.slice(-96 * 4);
  const highs = last4d.map(k => k.high);
  const lows = last4d.map(k => k.low);
  const support = Math.min(...lows);
  const resistance = Math.max(...highs);
  const rangePct = ((resistance - support) / support) * 100;
  if (rangePct < CONFIG.gridRangeMin || rangePct > CONFIG.gridRangeMax) return null;

  let sTouches = 0, rTouches = 0;
  const thresh = 0.005;
  last4d.forEach(k => {
    if (k.low <= support * (1 + thresh)) sTouches++;
    if (k.high >= resistance * (1 - thresh)) rTouches++;
  });
  if (sTouches < CONFIG.gridMinTouches || rTouches < CONFIG.gridMinTouches) return null;

  const current = klines[klines.length - 1].close;
  const pos = (current - support) / (resistance - support);
  if (pos < 0.2 || pos > 0.8) return null;

  const closes = klines.map(k => k.close);
  const ema28 = calculateEMA(closes, 28);
  const ema28Prev = calculateEMA(closes.slice(0, -1), 28);
  const slope = Math.abs(ema28 - ema28Prev) / ema28Prev;
  if (slope > CONFIG.emaSlopeMax) return null;

  return {
    support,
    resistance,
    rangePct,
    touches: { support: sTouches, resistance: rTouches },
    currentPosition: (pos * 100).toFixed(1)
  };
}

// --- MAIN SCAN FUNCTION ---
async function scanLive() {
  const scanBtn = document.getElementById('scanBtn');
  const status = document.getElementById('status');
  const resultDiv = document.getElementById('result');
  const progressFill = document.getElementById('progressFill');
  const coinTableContainer = document.getElementById('coinTableContainer');

  const scanMode = scanModeSelect.value;
  const minVol = parseFloat(minVolumeInput.value);
  // üîí CRITICAL: Hardcode RSI periods by strategy ‚Äî ignore user selection in logic
  // User dropdown is for display/debug only

  scanBtn.disabled = true;
  scanBtn.textContent = '‚è≥ Scanning...';
  status.innerHTML = 'Starting scan...';
  resultDiv.innerHTML = '';
  debugLog = [];
  logDebug('=== Starting new scan (RSI periods locked per strategy) ===');

  const validSignals = [];
  const coinData = [];
  const totalCoins = COIN_UNIVERSE.length;
  let scanned = 0;

  for (const symbol of COIN_UNIVERSE) {
    try {
      logDebug(`\n=== Scanning ${symbol} ===`);
      status.innerHTML = `Scanning ${symbol} (${scanned + 1}/${totalCoins})...`;
      progressFill.style.width = `${((scanned + 1) / totalCoins) * 100}%`;

      const url = `https://api.bybit.com/v5/market/kline?category=linear&symbol=${symbol}&interval=15&limit=500`;
      const resp = await fetch(url);
      const data = await resp.json();

      if (data.retCode !== 0 || !data.result?.list) {
        logDebug(`API error: ${data.retMsg || 'No data'}`);
        scanned++;
        continue;
      }

      const klines = data.result.list.map(c => ({
        time: parseInt(c[0]),
        open: parseFloat(c[1]),
        high: parseFloat(c[2]),
        low: parseFloat(c[3]),
        close: parseFloat(c[4]),
        volume: parseFloat(c[5])
      })).reverse();

      if (klines.length < 100) {
        logDebug('Insufficient klines');
        scanned++;
        continue;
      }

      const closes = klines.map(k => k.close);
      const vols = klines.map(k => k.volume);
      const price = closes[closes.length - 1];
      // ‚úÖ STRATEGY-LOCKED RSI: ALWAYS USE 6 AND 14
      const rsi6 = calculateRSI(closes, 6);     // Fast trigger
      const rsi14 = calculateRSI(closes, 14);   // Trend filter
      const ema7 = calculateEMA(closes, 7);
      const ema28 = calculateEMA(closes, 28);
      const volRatio = calculateVolumeRatio(vols);
      const grid = validateGrid(klines);

      // Log if user selected non-default (for awareness)
      const userRsi = rsiPeriodSelect.value;
      if (userRsi !== '6') {
        logDebug(`Note: Display shows RSI(${userRsi}), but signals use RSI(6)/RSI(14)`);
      }

      coinData.push({ symbol, price, rsi6, rsi14, ema7, ema28, volRatio, grid });

      // --- FLASH SIGNALS (always use RSI6 + RSI14) ---
      if (scanMode === 'full' || scanMode === 'flash') {
        if (rsi6 < 22 && rsi14 < 30 && volRatio >= Math.max(minVol, 2.0) && price >= ema7 * 0.98) {
          const tp = (price * 1.20).toFixed(4);
          validSignals.push({
            type: 'flash',
            symbol,
            message: `üü¢ FLASH 5x: ${symbol} | RSI6:${rsi6.toFixed(1)} RSI14:${rsi14.toFixed(1)} | Vol:${volRatio.toFixed(1)}√ó | TP:+20% ‚Üí ${tp}`
          });
        }
        else if (rsi6 >= 22 && rsi6 < 27 && rsi14 >= 30 && rsi14 < 40 && volRatio >= Math.max(minVol, 1.5) && price >= ema7 * 0.98) {
          const tp = (price * 1.15).toFixed(4);
          validSignals.push({
            type: 'flash',
            symbol,
            message: `üü° FLASH 3x: ${symbol} | RSI6:${rsi6.toFixed(1)} RSI14:${rsi14.toFixed(1)} | Vol:${volRatio.toFixed(1)}√ó | TP:+15% ‚Üí ${tp}`
          });
        }
      }

      // --- CHAOS SIGNALS ---
      if (scanMode === 'full' || scanMode === 'chaos') {
        const recentHigh = Math.max(...klines.slice(-20).map(k => k.high));
        const dropPct = ((recentHigh - price) / recentHigh) * 100;
        if (rsi6 < 15 && rsi14 < 25 && volRatio >= Math.max(minVol, 3.0) && dropPct >= CONFIG.chaosDropMin) {
          const tp = (price * 1.20).toFixed(4);
          validSignals.push({
            type: 'chaos',
            symbol,
            message: `üî¥ CHAOS: ${symbol} | RSI6:${rsi6.toFixed(1)} RSI14:${rsi14.toFixed(1)} | Vol:${volRatio.toFixed(1)}√ó | Drop:-${dropPct.toFixed(0)}% | TP:+20% ‚Üí ${tp}`
          });
        }
      }
      // --- GRID SIGNALS ---
      if (scanMode === 'full' || scanMode === 'grid') {
        if (grid && rsi6 >= 35 && rsi6 <= 50 && rsi14 >= 40 && rsi14 <= 60) {
          validSignals.push({
            type: 'grid',
            symbol,
            message: `üü† GRID: ${symbol} | Range:${grid.support.toFixed(4)}-${grid.resistance.toFixed(4)} (${grid.rangePct.toFixed(2)}%) | Pos:${grid.currentPosition}% | Validated 4 days`
          });
        }
      }

      scanned++;
      await new Promise(r => setTimeout(r, 300));

    } catch (err) {
      logDebug(`‚ùå Error ${symbol}: ${err.message}`);
      scanned++;
      continue;
    }
  }

  progressFill.style.width = '100%';

  if (validSignals.length > 0) {
    resultDiv.innerHTML = validSignals.map(s => `<div class="signal ${s.type}">${s.message}</div>`).join('');
    status.innerHTML = `‚úÖ Scan complete. Found ${validSignals.length} signals.`;
  } else {
    resultDiv.innerHTML = '‚è≥ No valid setups found.\nWait for clear signals.';
    status.innerHTML = 'Scan complete. No signals found.';
  }

  generateCoinTable(coinData);
  scanBtn.disabled = false;
  scanBtn.textContent = 'üåê Scan Live Coin Universe';
  logDebug('=== Scan complete ===');
}

function generateCoinTable(coinData) {
  const container = document.getElementById('coinTableContainer');
  if (!coinData || coinData.length === 0) {
    container.innerHTML = '<p>No coin data available.</p>';
    return;
  }

  let html = `
    <div style="overflow-x: auto;">
      <table class="coin-table">
        <thead>
          <tr>
            <th>Coin</th>            <th>Price</th>
            <th>RSI6</th>
            <th>RSI14</th>
            <th>EMA7</th>
            <th>EMA28</th>
            <th>Vol Ratio</th>
            <th>Grid Support</th>
            <th>Grid Resistance</th>
            <th>Grid Range%</th>
          </tr>
        </thead>
        <tbody>
  `;

  coinData.forEach(c => {
    const gS = c.grid ? c.grid.support.toFixed(4) : '-';
    const gR = c.grid ? c.grid.resistance.toFixed(4) : '-';
    const gRange = c.grid ? c.grid.rangePct.toFixed(2) : '-';

    let rsiColor = '#f0f0f0';
    if (c.rsi6 < 30) rsiColor = '#ef4444';
    else if (c.rsi6 > 70) rsiColor = '#10b981';

    html += `
      <tr>
        <td><strong>${c.symbol}</strong></td>
        <td>${c.price.toFixed(4)}</td>
        <td style="color: ${rsiColor}">${c.rsi6.toFixed(2)}</td>
        <td>${c.rsi14.toFixed(2)}</td>
        <td>${c.ema7 ? c.ema7.toFixed(4) : '-'}</td>
        <td>${c.ema28 ? c.ema28.toFixed(4) : '-'}</td>
        <td>${c.volRatio.toFixed(2)}</td>
        <td>${gS}</td>
        <td>${gR}</td>
        <td>${gRange}</td>
      </tr>
    `;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}
</script>

<div class="footer">
  <p>Bybit-native ‚Ä¢ RSI(6)+RSI(14) Locked per Strategy ‚Ä¢ MT-Validated</p>
  <p>v3.5.4 | Flash x5 / Grid x3 / Chaos | No User Override on RSI Logic</p>
</div>

</body></html>
